# Итоговая сводка: Система валидации нод

## Что было реализовано

Реализована полноценная система валидации нод для редактора сценариев с архитектурой на основе **контрактов** и **регистра валидаторов**.

## Решенные проблемы

### 1. ✅ Автосохранение не отправляет невалидные данные
**Проблема:** При создании новой ноды автосохранение отправляло запрос с незаполненными данными.

**Решение:** В `useSaveScenario.ts` добавлена проверка валидности перед отправкой:
- Система автоматически проверяет все ноды перед сохранением
- Если есть невалидные ноды - запрос не отправляется
- Пользователь видит детальное сообщение с перечислением ошибок

### 2. ✅ Блокировка создания новых нод при наличии невалидных
**Проблема:** Нужно запретить создание новой ноды, если есть нода которая не проходит валидацию.

**Решение:** В `NewNodesPanel.tsx` добавлена проверка перед созданием:
- При попытке создать новую ноду проверяется наличие невалидных нод
- Если есть невалидные - показывается alert с перечислением проблем
- Пользователь должен исправить существующие ноды перед созданием новых

## Архитектура системы

### Структура файлов

```
validation/
├── contracts/
│   └── ValidationContract.ts        # Интерфейс для всех валидаторов
├── validators/
│   ├── BaseStepValidator.ts         # Базовая валидация для степов
│   ├── ActivityModbusStepValidator.ts
│   ├── ActivitySystemStepValidator.ts
│   ├── DelayStepValidator.ts
│   ├── SignalStepValidator.ts
│   ├── JumpStepValidator.ts
│   ├── ParallelStepValidator.ts
│   ├── ConditionStepValidator.ts
│   └── BranchValidator.ts
├── ValidationRegistry.ts            # Реестр всех валидаторов
├── nodeValidation.ts                # Публичное API
├── useScenarioValidation.ts         # React хук для валидации
├── index.ts                         # Экспорты
└── README.md                        # Документация

Интеграция:
├── useSaveScenario.ts              # Интеграция в автосохранение
└── NewNodesPanel.tsx               # Интеграция в создание нод
```

### Принципы дизайна

1. **Контракт-ориентированная архитектура**
   - Каждый валидатор реализует `NodeValidationContract`
   - Единообразный интерфейс для всех валидаторов
   - Легко добавлять новые валидаторы

2. **Наследование через BaseStepValidator**
   - Базовый класс проверяет общие поля (name, taskQueue)
   - Конкретные валидаторы добавляют специфичные проверки
   - Переиспользование кода и DRY принцип

3. **Централизованный реестр**
   - `ValidationRegistry` хранит все валидаторы
   - Автоматическая регистрация при инициализации
   - Доступ к валидаторам по типу ноды

4. **Композиция результатов**
   - `combineValidationResults` объединяет ошибки
   - Базовая и специфичная валидация работают независимо
   - Полный список всех ошибок в одном результате

## Правила валидации

### Общие для всех степов:
- `name` - обязательное, не пустое
- `taskQueue` - обязательное, не пустое

### Специфичные:
- **ActivityModbusStep:** sessionId, connectionConfigId, modbusDeviceActionId, modbusDeviceAddressId
- **ActivitySystemStep:** systemActionId
- **DelayStep:** timeSpan (не PT0S)
- **SignalStep:** signalKey
- **JumpStep:** jumpToStepId
- **ParallelStep:** минимум 2 ветки
- **ConditionStep:** минимум 2 ветки
- **BranchNode:** name

## Как использовать

### В компонентах:

```typescript
import { useScenarioValidation } from '@scenario/core/features/validation';

const validation = useScenarioValidation(scenarioId);

if (validation.hasInvalidNodes) {
  console.log('Невалидные ноды:', validation.invalidNodes);
}
```

### Добавление нового валидатора:

1. Создайте класс валидатора в `validators/`
2. Наследуйтесь от `BaseStepValidator` или реализуйте `NodeValidationContract`
3. Зарегистрируйте в `ValidationRegistry.ts`

## Преимущества решения

✅ **Масштабируемость** - легко добавить новый тип ноды
✅ **Поддерживаемость** - каждый валидатор в отдельном файле
✅ **Типобезопасность** - TypeScript контракты для валидаторов
✅ **Переиспользование** - базовый класс для общей логики
✅ **Расширяемость** - можно добавлять сложные правила валидации
✅ **Тестируемость** - каждый валидатор легко протестировать

## Что дальше?

Возможные улучшения (опционально):

1. **Визуальная индикация** - подсветка невалидных нод на карте
2. **Real-time валидация** - показывать ошибки при редактировании
3. **Детальные подсказки** - как исправить конкретную ошибку
4. **Валидация связей** - проверка корректности графа
5. **Асинхронная валидация** - проверка данных на сервере
6. **Локализация** - сообщения на разных языках

## Тестирование

Для тестирования системы:

1. Создайте новую ноду
2. Попробуйте создать еще одну - должно показать alert
3. Заполните данные в первой ноде
4. Теперь можно создавать новые ноды
5. Автосохранение работает только с валидными нодами

## Заключение

Система валидации полностью решает поставленные задачи:
- ✅ Автосохранение не отправляет невалидные данные
- ✅ Блокировка создания новых нод при наличии невалидных
- ✅ Контракт-ориентированная архитектура
- ✅ Легко расширяемая и поддерживаемая
