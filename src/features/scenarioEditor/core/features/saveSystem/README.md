# Save System

–°–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π.

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### Core –º–æ–¥—É–ª–∏

- **`operationBuilder.ts`** - –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å–∏ –∏—Å—Ç–æ—Ä–∏–∏ (`HistoryRecord[]`) –≤ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞ (`ScenarioOperationDto[]`)
- **`saveSettingsSlice.ts`** - Redux slice –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–∞–≤—Ç–æ/—Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º, —Å—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
- **`useSaveScenario.ts`** - –•—É–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º (debounce 3 —Å–µ–∫—É–Ω–¥—ã)

### UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- **`SaveIndicator`** - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–æ—à–∏–±–∫–∞)
- **`SaveSettingsButton`** - –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ä–µ–∂–∏–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- **`ManualSaveButton`** - –ö–Ω–æ–ø–∫–∞ —Ä—É—á–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ)
- **`PreviewOperationsButton`** - –ö–Ω–æ–ø–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π** - –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (—Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ) –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ `historySlice`
2. **–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π** - –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ `operationBuilder` –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç API
3. **–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π** - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞–¥ –æ–¥–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç—å—é —Å—Ö–ª–æ–ø—ã–≤–∞—é—Ç—Å—è –≤ –æ–¥–Ω—É:
   - `Create + Update(s)` ‚Üí `Create` (—Å —Ñ–∏–Ω–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏)
   - `Create + Delete` ‚Üí –Ω–∏—á–µ–≥–æ (—Å—É—â–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∞ –∏ —Å—Ä–∞–∑—É —É–¥–∞–ª–µ–Ω–∞)
   - `Update(s)` ‚Üí `Update` (—Å —Ñ–∏–Ω–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏)
   - `Update(s) + Delete` ‚Üí `Delete` (—Å –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏)
4. **–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä** - —á–µ—Ä–µ–∑ `useApplyScenarioChangesMutation` (RTK Query)
5. **–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏** - –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–∞–µ—Ç—Å—è

### –ü—Ä–∏–º–µ—Ä –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è

–ò—Å—Ç–æ—Ä–∏—è:
```
1. Update Node X: { x: 100, y: 100, name: "Step 1" }
2. Update Node X: { x: 150, y: 100, name: "Step 1" }
3. Update Node X: { x: 150, y: 120, name: "Step 1" }
4. Update Node X: { x: 150, y: 120, name: "New Step" }
```

–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (1 –æ–ø–µ—Ä–∞—Ü–∏—è):
```
Update Node X: { x: 150, y: 120, name: "New Step" }
```

## –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

### –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- –ò–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
- –¢–∞–π–º–µ—Ä —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ (debounce)
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage

### –†—É—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
- –ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à Ctrl+S (TODO)

## –§–æ—Ä–º–∞—Ç –æ–ø–µ—Ä–∞—Ü–∏–π

```typescript
interface ScenarioOperationDto {
  opId: Guid;              // ID –æ–ø–µ—Ä–∞—Ü–∏–∏ (–∏–∑ history record)
  entity: DbEntityType;    // Step | StepRelation | Branch
  action: DbActionType;    // Create | Update | Delete
  payload: unknown;        // DTO —Å—É—â–Ω–æ—Å—Ç–∏
}
```

## API Endpoint

```
POST /scenarios/{id}/change
Body: {
  scenarioId: Guid,
  operations: ScenarioOperationDto[]
}
```

## –í–∏–∑—É–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### SaveIndicator
- üü¢ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ** - –∑–µ–ª—ë–Ω—ã–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- üü° **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...** - –∂—ë–ª—Ç—ã–π —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
- üî¥ **–û—à–∏–±–∫–∞** - –∫—Ä–∞—Å–Ω—ã–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏

### ManualSaveButton
- **–ê–∫—Ç–∏–≤–Ω–∞** - —Å–∏–Ω—è—è –∫–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
- **–ù–µ–∞–∫—Ç–∏–≤–Ω–∞** - —Å–µ—Ä–∞—è –∫–Ω–æ–ø–∫–∞ (–Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- **–°–∫—Ä—ã—Ç–∞** - –≤ —Ä–µ–∂–∏–º–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

### PreviewOperationsButton
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ badge
- –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–≤—É–º—è –≤–∫–ª–∞–¥–∫–∞–º–∏:
  - **–°–ø–∏—Å–æ–∫** - —á–µ–ª–æ–≤–µ–∫–æ-—á–∏—Ç–∞–µ–º—ã–π —Å–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π
  - **JSON** - —Å—ã—Ä–æ–π JSON –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏/–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ `ScenarioMap.tsx`:
- **Top-right Panel**: `SaveSettingsButton`, `SaveIndicator`
- **Top-left Panel**: `ManualSaveButton`, `PreviewOperationsButton`

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- Redux (`saveSettings` reducer –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ `rootReducer.ts`)
- RTK Query (`scenarioApi.useApplyScenarioChangesMutation`)
- History System (—á–∏—Ç–∞–µ—Ç `history.contexts[scenarioId].past`)

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —Å—É—â–Ω–æ—Å—Ç–µ–π:

1. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π —Ç–∏–ø –≤ `StepType` enum (–µ—Å–ª–∏ —ç—Ç–æ —à–∞–≥) –∏–ª–∏ –≤ `FlowType` (–µ—Å–ª–∏ –¥—Ä—É–≥–∞—è —Å—É—â–Ω–æ—Å—Ç—å)
2. –û–±–Ω–æ–≤–∏—Ç–µ `ENTITY_TYPE_MAP` –≤ `operationBuilder.ts`:

```typescript
import { FlowType } from '@scenario/core/ui/nodes/types/flowType';

const ENTITY_TYPE_MAP: Record<string, DbEntityType> = {
  [FlowType.YourNewStep]: DbEntityType.Step,
  // ...
};
```
