# –°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤–∏–¥–µ—Ç—å:
- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (Create, Update, Delete)
- –î–ª—è –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å:
  - **"–ö–∞–∫ –±—ã–ª–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"** (before) - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–ª–µ lastSyncedIndex
  - **"–ö–∞–∫ —Å—Ç–∞–ª–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ"** (after) - —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
  - –î–µ—Ç–∞–ª—å–Ω—ã–π diff —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø–æ–ª–µ–π

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ diff –¥–∞–Ω–Ω—ã—Ö

**`operationDiffBuilder.ts`**

–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: `buildOperationDiff(operation, historyRecords, lastSyncedIndex)`

**–õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è before/after:**

**–ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç:** `before` - —ç—Ç–æ –≤—Å–µ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏ –ù–ê –ú–û–ú–ï–ù–¢ `lastSyncedIndex` (—Ç–æ –µ—Å—Ç—å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä). –≠—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø–æ—Å–ª–µ Undo –æ–ø–µ—Ä–∞—Ü–∏–π.

- **Create:**
  - `before` = —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ –º–æ–º–µ–Ω—Ç lastSyncedIndex (–æ–±—ã—á–Ω–æ `null`, –µ—Å–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –±—ã–ª–æ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
  - `after` = —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–π snapshot)

- **Update:**
  - `before` = —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ –º–æ–º–µ–Ω—Ç lastSyncedIndex (–∫–∞–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
  - `after` = —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–π snapshot)

- **Delete:**
  - `before` = —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ –º–æ–º–µ–Ω—Ç lastSyncedIndex (–∫–∞–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–æ —É–¥–∞–ª–µ–Ω–∏—è)
  - `after` = `null` (—Å—É—â–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∞)

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Undo

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ò–∑–º–µ–Ω–µ–Ω–∏–µ ‚Üí –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Üí Undo

1. –î–µ–ª–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –Ω–æ–¥—ã)
2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä ‚Üí `lastSyncedIndex` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
3. –î–µ–ª–∞–µ–º Undo (–æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ)
4. –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `before` = —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ü–û–°–õ–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (—Ç–æ —á—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å–µ–π—á–∞—Å)
- `after` = —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ü–û–°–õ–ï Undo (—Ç–µ–∫—É—â–µ–µ –ª–æ–∫–∞–ª—å–Ω–æ–µ)
- Diff –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –æ–±—Ä–∞—Ç–Ω–æ

–§—É–Ω–∫—Ü–∏—è `findServerStateForEntity` –∏—â–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –î–û `lastSyncedIndex`, —á—Ç–æ –¥–∞—ë—Ç –Ω–∞–º —Ç–æ—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

### 2. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã UI

#### `ChangeItem`
–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –æ–¥–Ω—É –æ–ø–µ—Ä–∞—Ü–∏—é –≤ —Å–ø–∏—Å–∫–µ:
- –ò–∫–æ–Ω–∫–∞ –ø–æ —Ç–∏–ø—É –æ–ø–µ—Ä–∞—Ü–∏–∏ (‚ûï, ‚úèÔ∏è, üóëÔ∏è)
- –ù–∞–∑–≤–∞–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏
- –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ —Ç–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏

#### `DiffViewer`
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π diff –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏:

**–î–ª—è Create:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–î–ª—è Delete:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —É–¥–∞–ª—è–µ–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–î–ª—è Update:**
- –°–≤–µ—Ä—Ö—É: —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø–æ–ª–µ–π —Å before/after
- –°–Ω–∏–∑—É: –¥–≤–∞ –ø–æ–ª–Ω—ã—Ö JSON (—Å–ª–µ–≤–∞ - "–∫–∞–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ", —Å–ø—Ä–∞–≤–∞ - "–∫–∞–∫ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ")

#### `ChangesPreviewPanel`
–û—Å–Ω–æ–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å –¥–≤—É–º—è –∫–æ–ª–æ–Ω–∫–∞–º–∏:
- –°–ª–µ–≤–∞: —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –°–ø—Ä–∞–≤–∞: –¥–µ—Ç–∞–ª—å–Ω—ã–π diff –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è

#### `OperationsPreviewModal`
–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ç–∞–±–∞–º–∏:
- Tab "–ò–∑–º–µ–Ω–µ–Ω–∏—è": –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç ChangesPreviewPanel
- Tab "JSON": –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç raw JSON –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### 3. –•—É–∫–∏

#### `useSavePreview(scenarioId)`
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
- `changes` - –º–∞—Å—Å–∏–≤ OperationDiff —Å before/after –¥–ª—è –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
- `changesCount` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- `hasChanges` - –µ—Å—Ç—å –ª–∏ –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í –∫–æ–¥–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞

```tsx
import { useSavePreview } from '@scenario/core/features/saveSystem/useSavePreview';

function MyComponent({ scenarioId }: { scenarioId: Guid }) {
    const { changes, changesCount, hasChanges } = useSavePreview(scenarioId);

    return (
        <div>
            {hasChanges && (
                <span>–ù–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π: {changesCount}</span>
            )}
        </div>
    );
}
```

### –í –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞

–ö–Ω–æ–ø–∫–∞ "–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" –≤ UI —É–∂–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø–æ–ª–Ω—ã–º diff –ø—Ä–∏ –∫–ª–∏–∫–µ.

## –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: Update –Ω–æ–¥—ã

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–ª —Å—Ü–µ–Ω–∞—Ä–∏–π (lastSyncedIndex = 5)
2. –ò–∑–º–µ–Ω–∏–ª –∏–º—è –Ω–æ–¥—ã: "Step 1" ‚Üí "Step 1 Updated"
3. –ò–∑–º–µ–Ω–∏–ª –ø–æ–∑–∏—Ü–∏—é: x: 100 ‚Üí x: 200
4. –ù–∞–∂–∞–ª "–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä"

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í —Å–ø–∏—Å–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è: "‚úèÔ∏è Update Step: Step 1 Updated"
- –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é:
  - **–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –ø–æ–ª—è:**
    - name: "Step 1" ‚Üí "Step 1 Updated"
    - x: 100 ‚Üí 200
  - **–ö–∞–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–¥–æ):** JSON —Å name = "Step 1", x = 100
  - **–ö–∞–∫ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–ø–æ—Å–ª–µ):** JSON —Å name = "Step 1 Updated", x = 200

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: Create ‚Üí Update ‚Üí –µ—â—ë Update

1. –°–æ–∑–¥–∞–ª–∏ –Ω–æ–¥—É
2. –ò–∑–º–µ–Ω–∏–ª–∏ –µ—ë –∏–º—è
3. –ò–∑–º–µ–Ω–∏–ª–∏ –µ—ë –ø–æ–∑–∏—Ü–∏—é
4. –ù–∞–∂–∞–ª–∏ "–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä"

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ–¥–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—è Create (–æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–º—ë—Ä–∂–µ–Ω—ã)
- before = null (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –µ—ë –Ω–µ—Ç)
- after = —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ –≤—Å–µ–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: Delete

1. –£–¥–∞–ª–∏–ª–∏ –Ω–æ–¥—É
2. –ù–∞–∂–∞–ª–∏ "–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä"

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è: "üóëÔ∏è Delete Step: Step 1"
- before = —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–æ–¥—ã –¥–æ —É–¥–∞–ª–µ–Ω–∏—è (–∫–∞–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
- after = null

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–æ–∏—Å–∫ –ø–µ—Ä–≤–æ–≥–æ before

–§—É–Ω–∫—Ü–∏—è `findFirstRecordForEntity` –∏—â–µ—Ç –ü–ï–†–í–£–Æ –∑–∞–ø–∏—Å—å –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏ –Ω–∞—á–∏–Ω–∞—è —Å `lastSyncedIndex`. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è "–∫–∞–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ".

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞—Ç—á–µ–π

–§—É–Ω–∫—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø—Ä–æ—Ö–æ–¥—è—Ç –ø–æ batch –∑–∞–ø–∏—Å—è–º, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–æ–∫.

### –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö

–ü–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º JSON —É–¥–∞–ª—è—é—Ç—Å—è —Å–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è:
- `entityType` - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ç–∏–ø –∫–ª–∏–µ–Ω—Ç–∞
- `__persisted` - —Ñ–ª–∞–≥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

## –û—Ç–ª–∞–¥–∫–∞

–ï—Å–ª–∏ diff –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ warnings –æ—Ç `operationDiffBuilder`
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `lastSyncedIndex` –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–æ—è—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–µ—Ä–µ–∑ Tab "JSON"
4. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∏—Å—Ç–æ—Ä–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç before/after snapshots

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –î–æ–±–∞–≤–∏—Ç—å diff –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (childRelations, parentRelations)
- [ ] –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –≤ JSON
- [ ] –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–∫—Ä—ã—Ç—å –Ω–µ–∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –ø–æ–ª—è
- [ ] –ü–æ–∏—Å–∫ –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º
- [ ] –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É –æ–ø–µ—Ä–∞—Ü–∏–∏ (Create/Update/Delete)
