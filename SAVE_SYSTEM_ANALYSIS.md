# Анализ системы сохранения после создания новой ноды

## Текущая ситуация (из логов):

```
1. [ActivitySystemNodeContract] Created system activity: 8c73b3d5-82e3-497c-a71b-641d332cddd8
   - systemActionId: undefined ❌
   
2. [ActivitySystemNodeContract] ⚠️ System activity created without systemActionId
   
3. [useSaveScenario] Building operations: {pastLength: 2, futureLength: 0, lastSyncedIndex: 0}
   
4. [operationBuilder] Skipping invalid operation: ActivitySystemStep requires systemActionId
   
5. [buildOperationsFromHistory] New operations created: 1
   - ActivitySystem операция пропущена ✅
   - Какая-то другая операция создана (возможно создание родительской ветки?)
```

## Корректное поведение системы:

### ✅ Работает правильно:
1. Новая нода создается без обязательных полей
2. Валидация определяет ноду как невалидную
3. operationBuilder фильтрует невалидную операцию
4. В preview операций нода НЕ показывается
5. Кнопка сохранения неактивна (если есть невалидные ноды)

### ❓ Вопросы для уточнения:
1. **Что именно "ломается"?**
   - Кнопка сохранения не активируется после заполнения полей?
   - Preview не обновляется после заполнения?
   - Операция не сохраняется на сервер?

2. **Ожидаемое поведение:**
   - Должна ли кнопка быть активной, если есть ДРУГИЕ валидные операции?
   - Или кнопка должна быть неактивна пока ВСЕ ноды не валидны?

## Возможные проблемы:

### Проблема 1: canSave блокирует ВСЕ сохранения
**Код:** `useSaveScenario.ts:76`
```typescript
const canSave = operations.length > 0 && !saveInProgress && scenarioId !== null && validation.canSave;
```

**Проблема:** Если есть хотя бы одна невалидная нода, `validation.canSave = false`, 
и сохранить НЕЛЬЗЯ, даже если есть другие валидные операции.

**Решение:** Это корректное поведение! Нельзя сохранять сценарий с невалидными нодами.

### Проблема 2: После заполнения полей операция не появляется
**Возможная причина:** Изменение полей ноды не создает новую запись в истории (Update операцию).

**Проверка:** Посмотреть, вызывается ли `operations.updateNode()` при изменении `systemActionId`.

## Рекомендации:

1. **Проверить логику обновления ноды** - создается ли Update операция при заполнении полей
2. **Убедиться, что валидация пересчитывается** после обновления полей
3. **Проверить, что operationBuilder создает Update операцию** для обновленной ноды

